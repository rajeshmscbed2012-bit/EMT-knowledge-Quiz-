<div class="w-full max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6 sm:p-8 transition-all duration-500">
  <!-- Error Display -->
  @if (error()) {
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md" role="alert">
      <p class="font-bold">Error</p>
      <p>{{ error() }}</p>
    </div>
  }

  <!-- Configuration State -->
  @if (quizState() === 'configuring') {
    <div class="animate-fade-in">
      <h2 class="text-2xl font-bold text-slate-700 mb-6">Create Your Quiz</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="topic" class="block text-sm font-medium text-gray-700 mb-1">Topic</label>
          <select id="topic" (change)="onTopicChange($event)" [value]="selectedTopic()" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            @for (topic of topics; track topic) {
              <option [value]="topic">{{ topic }}</option>
            }
          </select>
          @if (selectedTopicDescription()) {
            <p class="mt-2 text-sm text-gray-600">{{ selectedTopicDescription() }}</p>
          }
        </div>
        <div>
          <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Question Type</label>
          <select id="type" (change)="onTypeChange($event)" [value]="selectedType()" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            @for (type of questionTypes; track type) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
        </div>
        <div>
          <label for="difficulty" class="block text-sm font-medium text-gray-700 mb-1">Difficulty</label>
          <select id="difficulty" (change)="onDifficultyChange($event)" [value]="selectedDifficulty()" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            @for (difficulty of difficulties; track difficulty) {
              <option [value]="difficulty">{{ difficulty }}</option>
            }
          </select>
        </div>
      </div>
       <div class="mt-6">
          <label for="numQuestions" class="block text-sm font-medium text-gray-700 mb-1">Number of Questions</label>
          <select id="numQuestions" (change)="onNumQuestionsChange($event)" [value]="selectedNumQuestions()" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
            @for (num of numQuestionsOptions; track num) {
              <option [value]="num">{{ num }} Questions</option>
            }
          </select>
        </div>
      <div class="mt-8 text-center">
        <button (click)="startQuiz()" class="bg-blue-600 text-white font-bold py-3 px-10 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105">
          Start Quiz
        </button>
      </div>
    </div>
  }

  <!-- Loading State -->
  @if (quizState() === 'loading') {
    <div class="flex flex-col items-center justify-center p-12 animate-pulse">
      <svg class="w-16 h-16 text-blue-500 animate-spin" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="mt-4 text-lg font-semibold text-slate-600">Generating your custom quiz with Gemini AI...</p>
    </div>
  }

  <!-- Active Quiz State -->
  @if (quizState() === 'active') {
    <div class="animate-fade-in">
       <div class="mb-6 text-center">
        <div [class]="'inline-block px-6 py-2 rounded-full font-mono text-2xl font-bold ' + (timer() <= 30 ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700')">
          Time Left: {{ formattedTime() }}
        </div>
      </div>
      @for (question of questions(); track $index; let i = $index) {
        <div class="mb-8 border-b border-gray-200 pb-8">
          <p class="text-lg font-semibold text-slate-800 mb-4">
            <span class="text-blue-600 font-bold">Question {{ i + 1 }}:</span> {{ question.questionText }}
          </p>
          <div class="space-y-3">
            @for (option of question.options; track $index; let j = $index) {
              <button (click)="selectAnswer(i, j)" [class]="'w-full text-left p-4 border rounded-lg transition duration-200 ' + (userAnswers()[i] === j ? 'ring-2 ring-blue-500 bg-blue-50' : 'bg-white hover:bg-gray-50')">
                <span class="font-medium">{{ 'ABCD'[j] }}.</span> {{ option }}
              </button>
            }
          </div>
        </div>
      }
      <div class="text-center mt-6">
        <button (click)="submitQuiz()" [disabled]="!allQuestionsAnswered()" class="bg-green-600 text-white font-bold py-3 px-10 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
          Submit Answers
        </button>
        @if (!allQuestionsAnswered()) {
          <p class="text-sm text-gray-500 mt-2">Please answer all questions to submit.</p>
        }
      </div>
    </div>
  }

  <!-- Review State -->
  @if (quizState() === 'review') {
    <div class="animate-fade-in">
      <div class="text-center mb-8 p-6 bg-blue-50 rounded-lg flex flex-col items-center">
        <h2 class="text-3xl font-bold text-slate-800">Quiz Complete!</h2>
        <p class="text-xl text-slate-600 mt-2">Your Score:</p>
        <div class="relative w-48 h-48 my-4">
          <svg class="w-full h-full -rotate-90" viewBox="0 0 160 160">
            <circle class="text-gray-200" stroke-width="12" stroke="currentColor" fill="transparent" r="70" cx="80" cy="80" />
            <circle
              [class]="'progress-ring__circle--animation ' + (score() >= 70 ? 'text-green-500' : 'text-orange-500')"
              stroke-width="12"
              stroke-linecap="round"
              stroke="currentColor"
              fill="transparent"
              r="70"
              cx="80"
              cy="80"
              [style.stroke-dasharray]="'440'"
              [style.--progress-value]="440 - (440 * score()) / 100"
            />
          </svg>
          <span class="absolute inset-0 flex items-center justify-center text-4xl font-bold text-slate-700">
            {{ score() }}%
          </span>
        </div>
      </div>

      @for (question of questions(); track $index; let i = $index) {
        <div class="mb-8 border-b border-gray-200 pb-8">
          <p class="text-lg font-semibold text-slate-800 mb-4 flex items-start">
            <span class="mr-2">
              @if (userAnswers()[i] === question.correctAnswerIndex) {
                <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              } @else {
                <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              }
            </span>
            <span><span class="text-blue-600 font-bold">Question {{ i + 1 }}:</span> {{ question.questionText }}</span>
          </p>
          <div class="space-y-3">
            @for (option of question.options; track $index; let j = $index) {
              <div [class]="'w-full text-left p-4 border rounded-lg ' + getAnswerClass(i, j)">
                <span class="font-medium">{{ 'ABCD'[j] }}.</span> {{ option }}
              </div>
            }
          </div>
        </div>
      }

      <div class="mt-8 text-center">
        <button (click)="startNewQuiz()" class="bg-blue-600 text-white font-bold py-3 px-10 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105">
          Take a New Quiz
        </button>
      </div>
    </div>
  }
</div>